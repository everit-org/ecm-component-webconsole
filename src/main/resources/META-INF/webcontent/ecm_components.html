<!--

    This file is part of Everit - ECM Component Webconsole.

    Everit - ECM Component Webconsole is free software: you can redistribute it and/or modify
    it under the terms of the GNU Lesser General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Everit - ECM Component Webconsole is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Lesser General Public License for more details.

    You should have received a copy of the GNU Lesser General Public License
    along with Everit - ECM Component Webconsole.  If not, see <http://www.gnu.org/licenses/>.

-->
<!DOCTYPE html>

<div data-eht-fragment="'content'" data-eht-render="'content'">
  <p class="statline ui-state-highlight"
    data-eht-text="'ECM component information: ' + ccMap.size() + ' container(s) in total.'">ECM component
    information: 5 container(s) in total.</p>

  <table id="plugin_table" class="tablesorter nicetable noauto ui-widget">
    <tbody data-eht-foreach="[({'ccSR', 'ccsrIdx'}) : ccMap.keySet()]" data-eht-render="'content'"
      data-eht-var="['cc' : ccMap.get(ccSR)]">
      <tr>
        <th class="ui-widget-header" colspan="2"><a data-eht-var="['serviceId' : ccSR.getProperty('service.id')]"
          data-eht-attr-href="appRoot + '/services/' + serviceId" data-eht-text="serviceId">1</a> - <span
          data-eht-var="['mpp' : cc]" data-eht-text="mpp.getObjectClassDefinition(null, null).name">Component
            name</span></th>
      </tr>
      <tr data-eht-render="(cc.getComponentRevisions().length > 0) ? 'all' : 'none'">
        <th class="col_ServiceId ui-widget-header header">Id</th>
        <th class="col_Name ui-widget-header header">State</th>
      </tr>

      <tr class="ui-state-default" data-eht-foreach="[({'componentRevision', 'crIdx'}) : cc.componentRevisions]"
        data-eht-var="['servicePid' : componentRevision.properties.get('service.pid')]"
        data-eht-attrprepend-class="(crIdx % 2 == 0) ? 'odd ' : 'even '">
        <td><div class="ui-icon ui-icon-triangle-1-e subpid"
            data-eht-attr-onclick="'ecm_components_switchDetailView(this, ' + ccSR.getProperty('service.id') + ', ' + (servicePid != null ? '\'' + servicePid + '\'' : 'null') +')'"
            title="Details">&nbsp;</div> <span
          data-eht-text="(servicePid != null) ? servicePid : cc.componentMetadata.componentId">Service PID</span></td>
        <td data-eht-text="componentRevision.state">ACTIVE</td>
      </tr>

      <tr>
        <td colspan="2">&nbsp;</td>
      </tr>


    </tbody>
  </table>

  <script type="text/javascript" data-eht-inline="'text'">
			function ecm_components_switchDetailView(htmlElement,
					containerServiceId, servicePid) {
				var jhe = $(htmlElement);
				if (jhe.hasClass("ui-icon-triangle-1-e")) {
					var queryURL = "@{pluginRoot}/" + containerServiceId;
					if (servicePid != null) {
						queryURL = queryURL + '/' + servicePid;
					}
					queryURL = queryURL + ".fragment";
					jQuery
							.get(queryURL)
							.done(function(data) {
								jhe.parent().append(data);
							})
							.fail(
									function(data) {
										alert("Cannot show details. Probably data is out of date.")
										return false;
									});
					jhe.removeClass("ui-icon-triangle-1-e");
					jhe.addClass("ui-icon-triangle-1-s");
				} else {
					jhe.siblings(".componentRevisionInfo").remove()
					jhe.removeClass("ui-icon-triangle-1-s");
					jhe.addClass("ui-icon-triangle-1-e");
				}
			}
		</script>

  <div class="componentRevisionInfo" data-eht-fragment="'componentRevision'"
    data-eht-render="(template_ctx.fragmentId == 'componentRevision') ? 'all' : 'none'">
    <table data-eht-var="['requirements' : revision.getRequirements(null)]">
      <tr data-eht-render="(requirements.size() > 0) ? 'all' : 'none'">
        <td class="aligntop" nowrap="nowrap" style="border: 0px none; font-weight: bold;" colspan="2">Requirements</td>
      </tr>
      <tr data-eht-render="(requirements.size() > 0) ? 'all' : 'none'" data-eht-foreach="['requirement' : requirements]">
        <td class="aligntop" style="border: 0px none" data-eht-text="requirement.requirementId">Requirement name</td>
        <td data-eht-render="(requirement.satisfied) ? 'all' : 'none'" class="aligntop" style="border: 0px none">
          <ul>
            <li data-eht-foreach="['wiredCapability' : requirement.wiredCapabilities]"
              data-eht-var="['isServiceCap' : wiredCapability instanceof org.everit.osgi.ecm.component.resource.ServiceCapability,
              'isBundleCap' : wiredCapability instanceof org.osgi.framework.wiring.BundleCapability]">
              <div data-eht-render="(isServiceCap) ? 'content' : 'none'">
                <p data-eht-var="['serviceRef' : wiredCapability.serviceReference]">
                  Service: <a data-eht-var="['serviceId' : serviceRef.getProperty('service.id')]"
                    data-eht-attr-href="appRoot + '/services/' + serviceId"><span data-eht-text="serviceId">Service
                      Id</span></a><span data-eht-render="(serviceRef.getProperty('service.pid') != null) ? 'all' : 'none'"
                    data-eht-text="' - ' + serviceRef.getProperty('service.pid')"> - Service PID</span><span
                    data-eht-render="(serviceRef.getProperty('service.description') != null) ? 'all' : 'none'"
                    data-eht-text="' - ' + serviceRef.getProperty('service.description')"> - Service Description</span>
                </p>
              </div>
              <p data-eht-render="(isBundleCap) ? 'all' : 'none'">
                Bundle Capability: <a data-eht-var="['bundleId' : wiredCapability.revision.bundle.bundleId]"
                  data-eht-attr-href="appRoot + '/bundles/' + bundleId" data-eht-text="bundleId">Bundle Id</a> - <span
                  data-eht-text="wiredCapability.revision.symbolicName + ':' + wiredCapability.revision.version">SymbolicName:Version</span>
              </p>
              <p data-eht-text="wiredCapability" data-eht-render="(!isServiceCap && !isBundleCap) ? 'all' : 'none'"></p>
            </li>
          </ul>
        </td>
        <td data-eht-render="(!requirement.satisfied) ? 'all' : 'none'" class="aligntop"
          style="border: 0px none; color: red;">Unsatisfied</td>
      </tr>
      <tr>
        <td class="aligntop" nowrap="nowrap" style="border: 0px none; font-weight: bold;" colspan="2">Properties</td>
      </tr>
      <tr data-eht-foreach="['propEntry' : revision.properties.entrySet()]">
        <td class="aligntop" style="border: 0px none" data-eht-text="propEntry.key">Property name</td>
        <td class="aligntop" style="border: 0px none" data-eht-text="propEntry.value">Property value</td>
      </tr>
      <tr data-eht-render="(revision.processingThread != null) ? 'all' : 'none'">
        <td class="aligntop" style="border: 0px none; font-weight: bold;">Processing thread</td>
        <td class="aligntop" style="border: 0px none"><a
          data-eht-attr-href="appRoot + '/threads/' + revision.processingThread.id"
          data-eht-attr-onclick="(!threadViewerAvailable) ? &quot;alert('To be able to see the state of the thread, Everit Thread Viewer Webconsole plugin should be installed. You can get it from maven central'); return false;&quot; : &quot;&quot;"
          data-eht-text="revision.processingThread.id + ' - ' + revision.processingThread.name">id - name</a></td>
      </tr>
      <tr data-eht-render="(revision.cause != null) ? 'all' : 'none'">
        <td class="aligntop" style="border: 0px none; font-weight: bold;">Cause</td>
        <td class="aligntop" style="border: 0px none"><pre
            data-eht-text="exceptionFormatter.format(revision.cause)">Some stacktrace</pre></td>
      </tr>
    </table>
  </div>
</div>